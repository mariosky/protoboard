{% extends "activitytree/base.html" %}

{% block content %}
 <!--Instructor Header BEGIN -->
<div class="container">

      <!--Instructor TABS -->
<div  class="row instructor-tab">
 <div class="col-md-10 col-md-offset-1">


        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link " href="/instructor">Mis Cursos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/activitybuilder">Mis Actividades</a>
          </li>
        </ul>
     </div>
</div>

    <!--Instructor Menu -->`
    <div class="container m-b-2">

        <nav class="navbar navbar-expand-lg  navbar-light bg-light">
            <ul class="navbar-nav me-auto mt-2 mt-lg-0">

                <li class="nav-item dropdown active">

                    <a class="nav-link dropdown-toggle" role="button" id="dropdownMenuButton"  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Nueva Actividad
                    </a>
                    <div id="sidebar"  class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#" id="htmlBtn">HTML</a>
                        <a class="dropdown-item" href="#" id="videoBtn">Video</a>
                        <a class="dropdown-item" href="/build_quiz">Quiz</a>
                        <a class="dropdown-item" href="/build_program">Program</a>
                    </div>
                </li>
                     </ul>

                <form class="form-inline  my-2 my-lg-0" role="search" onsubmit="return false">
                    <input class="form-control  me-sm-2" type="search" placeholder="Titulo o #Tag" name="srch-term" id="txtname" >
                    <button class="btn btn-outline-success  my-2 my-sm-0" type="submit">Buscar</button>
                </form>


        </nav>
    </div>



 <!--Instructor Header END -->


        <div class="container mt-3 mb-3">

            <ul id="actividades"  class="list-group">



            </ul>

        </div>




 <!--Instructor Header END -->



      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12"  >
             <nav aria-label="Page navigation" id="paginator" align="center">


    </nav>
        </div>
    </div>






<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" align="center" style="font-size: large">
                Cuidado <i class="fa fa-exclamation-circle"></i>
            </div>
            <div class="modal-body" align="center">
               <h5> Mensaje <p class="debug-url"></p> </h5>
            </div>
            <div class="modal-footer" >
                <div class="mb-3" align="center">
                <button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancelar</button>
                <a class="btn btn-danger btn-ok">Borrar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalhtml">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-lg">
            <div class="modal-header">

                <h4 class="modal-title">HTML</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs">
                    <li class="nav-item"> <a class="nav-link active" href="#main"   data-bs-toggle="tab">Principal</a></li>
                    <li class="nav-item"> <a class="nav-link" href="#detail"   data-bs-toggle="tab">Detalle</a></li>
                </ul>
                <div class="container mt-3">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="main">
                        <div class="container-fluid">
                            <form id="formahtml" >{% csrf_token %}
                                <div class="mb-3">
                                    <label for="title">Nombre </label>
                                    <input type="text" class="form-control" id="titleHtml" name="title"  placeholder="Nombre del material didáctico" required="true">
                                </div>

                                <div class="mb-3">
                                    <label for="descriptionhtml">Descripción</label>
                                    <textarea class="form-control" id="descriptionhtml" name="description" rows="3" placeholder="Agrega una breve descripción del material."></textarea>
                                </div>
                                <div class="mb-3">
                                   <label for="authortext">Autor</label>
                                   <input type="text" class="form-control" id="authortext" name="author" value="{{ user.first_name}} {{user.last_name}}">
                                   <small class="form-text text-muted"> Nombre del autor principal del material.</small>
                                </div>

                                <div class="mb-3">
                                    <label for="autorphoto">Foto del autor</label>
                                    <input type="url" class="form-control" id="autorphoto" name="author_image">
                                    <small class="form-text text-muted"> Puedes incluir aquí la dirección de la foto del autor.</small>
                                </div>


                                <div class="mb-3">
                                   <label for="autorimagen">Publisher</label>
                                   <input type="text" class="form-control" id="publisherhtml" name="publisher">
                                   <small class="form-text text-muted"> Entidad responsable del material. </small>
                                </div>

                                <div class="mb-3">
                                    <label for="tagshtml">Hashtags:</label>
                                    <input class="form-control" id="tagshtml" name="tags"  placeholder="Crea los hashtags con la tecla Tab">
                                    <small id="tagsHelp" class="form-text text-muted">Los tags nos ayudan a clasificar el material, agrega varios. Ejemplos:
                                        java arreglos avanzado, apache-hadoop big-data. Se crean con la tecla tab. </small>
                                </div>
                                    <input type="hidden" id="type" name="type" value="text">
                                   

                                <div class="mb-3">
                                    <label for="content">Contenido HTML</label>
                                    <tinytext name="content" id="content"></tinytext>
                                    <small id="contentHelp" class="form-text text-muted"> Se utiliza la hoja de estilo de bootstrap 4. </small>
                                </div>


                            </form>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="detail">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">
                                    <form id="formadetail" style="align-content: center">
                                        <div class="mb-3" >
                                            <label for="idhtml">ID</label>
                                            <input type="text" readonly="readonly" class="form-control" id="idhtml" name="_id">
                                             <small class="form-text text-muted"> Este es el identificador interno del material didáctico. Se asigna automáticamente. </small>
                                         </div>
                                        <div class="mb-3">
                                        <label for="rightshtml">Licencia</label>
                                            <input type="text" class="form-control" id="rightshtml" name="rights" value="Attribution-ShareAlike 4.0 International">
                                            <small class="form-text text-muted"> Especifica el tipo de licencia del material. En caso de que estés utilizando algún material
                                            que no hayas hecho tu, debes indicar la Licencia original. Te sugerimos una licencia que permite a otros utilizar libremente
                                            tu apotación para hacer nuevos trabajos. Puedes elegir como tu propia licencia en:
                                                <a href="https://creativecommons.org/choose/">https://creativecommons.org/choose/</a> </small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="rightsurlhtml">URL Licencia</label>
                                            <input type="url" class="form-control" id="rightsurlhtml" name="rights_url">
                                            <small class="form-text text-muted"> Puedes incluir aquí la dirección de la licencia.</small>
                                        </div>


                                        <div class="mb-3">
                                            <label for="externalhtml">URL Externo</label>
                                            <input type="url" class="form-control" id="externalhtml" name="external_url">
                                            <small class="form-text text-muted"> Puedes incluir aquí una dirección externa referente al material original.</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="durationhtml">Duración estimada</label>
                                            <input type="text" class="form-control" id="durationhtml" name="duration">
                                            <small class="form-text text-muted"> Duración estimada del recurso. (HH:MM:SS) </small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="datehtml">Fecha de creación</label>
                                            <input type="text" class="form-control" id="datehtml" name="creation_date">
                                            <small class="form-text text-muted"> Fecha de creación (DD/MM/AAAA) </small>
                                        </div>

                                        <div class="mb-3">
                                             <label for="iconhtml">Ícono</label>
                                             <select id="iconhtml" name="icon" >
                                                <option value="coffee">Tasa de Café</option>
                                                <option value="file" selected>Archivo</option>
                                                <option value="youtube-play">Youtube</option>
                                                <option value="puzzle-piece">Pieza de Rompecabezas</option>
                                            </select>
                                             <small class="form-text text-muted"> Elige el ícono que acompañará al nombre del recurso.</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="levelhtml">Nivel</label>
                                            <select id="levelhtml" name="level">
                                                <option value="principiante">Básico</option>
                                                <option value="intermedio">Intermedio</option>
                                                <option value="avanzado">Avanzado</option>
                                            </select>
                                           <small class="form-text text-muted"> Esta es una etiqueta que puede servir para filtrar el tipo de material por niveles. </small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="is_privatehtml">Es público</label>
                                            <select id="is_privatehtml" name="is_private">
                                                <option value="true">Si</option>
                                                <option value="false">No</option>
                                            </select>
                                           <small class="form-text text-muted"> Indica si el material puede ser visto desde la biblioteca.</small>
                                        </div>

                                        <div class="mb-3">

                                        <label for="image_url">URL de Ímagen</label>
                                        <input type="url" class="form-control" id="image_url" name="image_url">
                                         <small class="form-text text-muted"> Puedes especificar una imagen externa que describa al recurso.
                                             Debes tener derechos sobre la ímagen. Puedes utilizar servicios como: imageshack.us o Amazon S3.

                                         </small>

                                            </div>







                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
            <div class="mb-3" align="center">

                <button type="button" data-bs-dismiss="modal" class="btn btn-secondary">Cancelar</button>
                <button id="_htmlActivity" type="submit" class="btn btn-primary">Guadar</button>
            </div>
        </div>
        </div>
    </div>
</div>



<div class="modal fade" id="modalvideo">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                     <h4 class="modal-title">Video</h4>
                     <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span></button>
                </div>
            <div class="modal-body">


                <ul class="nav nav-tabs">
                    <li class="nav-item"> <a class="nav-link active" href="#mainv"   data-bs-toggle="tab">Principal</a></li>
                    <li class="nav-item"> <a class="nav-link" href="#detailv"   data-bs-toggle="tab">Detalle</a></li>
                </ul>
                <div class="container mt-3">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="mainv">

                            <form id="formaVideo" >{% csrf_token %}
                                 <div class="mb-3">
                                    <label for="title">Nombre</label>
                                    <input type="text" class="form-control" id="titleVideo" name="title"  required="true"  placeholder="Nombre del material didáctico">
                                 </div>
                                 <div class="mb-3">
                                    <label for="descriptionvideo">Descripción</label>
                                    <textarea class="form-control" id="descriptionvideo" name="description" placeholder="Agrega una breve descripción del material." rows="3"></textarea>
                                 </div>
                                <div class="mb-3">
                                    <label for="authorvideo">Autor</label>
                                    <input type="text" class="form-control" id="authorvideo" name="author" value="{{ user.first_name}} {{user.last_name}}">
                                    <small class="form-text text-muted"> Nombre del autor principal del material.</small>
                                </div>

                                <div class="mb-3">
                                    <label for="autorphoto">Foto del autor</label>
                                    <input type="url" class="form-control" id="autorphoto" name="author_image">
                                    <small class="form-text text-muted"> Puedes incluir aquí la dirección de la foto del autor.</small>
                                </div>                                 
                                 <div class="mb-3">
                                    <label for="tagsvideo">Hashtags</label>
                                    <input class="form-control input-optional" id="tagsvideo" name="tags">
                                   <small id="tagsHelp" class="form-text text-muted">Los tags nos ayudan a clasificar el material, agrega varios. Ejemplos:
                                        java arreglos avanzado, apache-hadoop big-data. Se crean con la tecla tab. </small>
                                 </div>

                                    <input type="hidden" id="type" name="type" value="video">
                                    
                                    <input type="hidden" id="youtube_id" name="youtube_id">
                                 <div class="mb-3">
                                        <label for="url">URL del Video</label>
                                        <input type="url" id="url" name="url" class="form-control" placeholder="https://www.youtube.com/watch?v=eJeMplo">
                                        <small id="tagsHelp" class="form-text text-muted">Inserta la URL del video en youtube que deseas presentar. </small>
                                 </div>
                                 <div class="form-inline">
                                    <div class="mb-3">
                                        <label for="startSeconds" class="">Inicia</label>
                                        <input type="number" min="0" class="form-control input-optional" id="startSeconds" name="startSeconds" >
                                    </div>

                                        <div class="mb-3">
                                            <label for="endSeconds" class="">Termina</label>
                                            <input type="number"  min="1" class="form-control input-optional" id="endSeconds" name="endSeconds" >
                                        </div>

                                 </div>
                                <small class="form-text text-muted">Puedes indicar en que segundo inicie y termine el video. </small>
                                    <div id="ytVideo" align="center">
                                       <small class="form-text text-muted">El video se mostará aquí. </small>
                                    </div>
                            </form>
                        </div>


                    <div class="tab-pane fade" id="detailv">

                        <div class="row">
                            <div class="col-md-12 ">
                                <form id="formadetailv" style="align-content: center">
                                    <div class="mb-3" >
                                        <label for="idvideo">ID</label>
                                        <input type="text" readonly="readonly" class="form-control" id="idvideo" name="_id">
                                        <small class="form-text text-muted"> Este es el identificador interno del material didáctico. Se asigna automáticamente. </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="rightsvideo">Licencia</label>
                                        <input type="text" class="form-control" id="rightsvideo" name="rights" value="Licencia estándar de YouTube">
                                          <small class="form-text text-muted"> Especifica el tipo de licencia del material. En caso de que estés utilizando algún material
                                            que no hayas hecho tu, debes indicar la Licencia original. Te sugerimos una licencia que permite a otros utilizar libremente
                                            tu apotación para hacer nuevos trabajos. Puedes elegir como tu propia licencia en:
                                                <a href="https://creativecommons.org/choose/">https://creativecommons.org/choose/</a> </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="rightsurlhtml">URL Licencia</label>
                                        <input type="url" class="form-control" id="rightsurlhtml" name="rights_url">
                                        <small class="form-text text-muted"> Puedes incluir aquí la dirección de la licencia.</small>
                                    </div>
                                    <div class="mb-3">
                                          <label for="externalvideo">URL Externo</label>
                                        <input type="text" class="form-control" id="externalvideo" name="external_url">
                                        <small class="form-text text-muted"> Puedes incluir aquí una dirección externa referente al material original.</small>
                                    </div>
                                    <div class="mb-3">
                                         <label for="publishervideo">Publisher</label>
                                        <input type="text" class="form-control" id="publishervideo" name="publisher">
                                        <small class="form-text text-muted"> Nombre de la entidad responsable del material.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="iconvideo">Ícono</label>
                                        <select id="iconvideo" name="icon" >
                                                <option value="coffee">Tasa de Café</option>
                                                <option value="file">Archivo</option>
                                                <option value="youtube-play" selected>Youtube</option>
                                                <option value="puzzle-piece">Pieza de Rompecabezas</option>
                                        </select>
                                        <small class="form-text text-muted"> Elige el ícono que acompañará al nombre del recurso.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="levelvideo">Level</label>
                                        <select id="levelvideo" name="level">
                                            <option value="principiante">Básico</option>
                                                <option value="intermedio">Intermedio</option>
                                                <option value="avanzado">Avanzado</option>
                                        </select>
                                        <small class="form-text text-muted"> Esta es una etiqueta que puede servir para filtrar el tipo de material por niveles. </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="is_privatehtml">Es público</label>
                                        <select id="is_privatehtml" name="is_private">
                                        <option value="true">Si</option>
                                        <option value="false">No</option>
                                        </select>
                                        <small class="form-text text-muted"> Indica si el material puede ser visto desde la biblioteca.</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="datehtml">Fecha de creación</label>
                                        <input type="text" class="form-control" id="datehtml" name="creation_date">
                                        <small class="form-text text-muted"> Fecha de creación (DD/MM/AAAA) </small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="durationhtml">Duración estimada</label>
                                        <input type="text" class="form-control" id="durationhtml" name="duration">
                                        <small class="form-text text-muted"> Duración estimada del recurso. (HH:MM:SS) </small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="image_url">URL de Ímagen</label>
                                        <input type="text" class="form-control" id="image_url" name="image_url">
                                        <small class="form-text text-muted"> Puedes especificar una imagen externa que describa al recurso.
                                             Debes tener derechos sobre la ímagen. Puedes utilizar servicios como: imageshack.us o Amazon S3.

                                         </small>
                                    </div>

                                </form>
                            </div>
                        </div>

                </div>
                </div>
                 </div>
            </div>
            <div class="modal-footer">
                <div class="mb-3" align="center">
                    <button type="button" data-bs-dismiss="modal" class="btn btn-secondary">Cancelar</button>
                   <button id="_videoActivity" type="submit" class="btn btn-primary">Guardar</button>

                </div>
            </div>
        </div>


    </div>
</div>

</div>






{% endblock %}

{% block scripts %}

{{block.super}}


    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.7.1/tinymce.min.js" referrerpolicy="origin"></script>
    <script>tinymce.init({ selector:'tinytext', height:"220", automatic_uploads:true, plugins: "image link code", toolbar:" undo redo| styleselect | bold italic | alignleft aligncenter alignright | link image | code " })</script>


<script id="activities_template" type="x-tmpsmustache">

        <li class="list-group-item list-group-item-action flex-column align-items-start">
             <div class="d-flex w-100  justify-content-between">

                 <h5 class="mb-1 text">  <i class="fa fa-[[icon]]"> </i> [[title]]</h5>
                 <small class="text-muted">
                          <i class="fa fa-tags"></i>

                          [[#tags]]
                          [[#.]]
                          <span class="label label-info">#[[.]]</span>
                          [[/.]]
                          [[^.]]
                          [[/.]]
                          [[/tags]]


                </small>
             </div>

             <p class="mb-1 text-muted">
                        [[#description]]
                           <p> [[description]]</p>
                       [[ /description ]]
                       [[^description]]
                          <p> Sin descripción </p>
                       [[/description]]
             </p>

            <small class="[[^progress_status]] text-muted [[/progress_status]] [[#progress_status]]  text-success     [[/progress_status]]           "><i class="[[icon]]"></i> [[activity_type]] </small>


                <button type="button" value="[[id]]" onclick='javascript:window.open("[[id]]", "_blank", "scrollbars=1,resizable=1,height=600,width=650");'  class="btn btn-primary"><i class="fa fa-eye"></i> </button>
                 <button type="button" value="[[id]]" onclick='get_activity("[[id]]","[[type]]")'  data-bs-toggle=""  data-bs-target="#"   data-bs-target="#confirm-edit" data-href="[[id]]" class="btn btn-primary"><i class="fa fa-cog"></i> </button>
                 <button type="button" value="[[id]]"  data-bs-toggle="modal"  data-bs-target="#confirm-delete"  data-href="[[id]]" class="btn btn-primary"><i class="fa fa-trash-o"></i></button>

     </li>



</script>



<script id="activities_template_old" type="x-tmpsmustache">

       <div class="col-sm-4">
          <div class="card">
          <div class="card-block">
            <h5 class="card-title">
              <i class="fa fa-[[icon]]"> </i> [[title]]
             </h5>
               [[#description]]
                   <p> [[description]]</p>
               [[ /description ]]
               [[^description]]
                  <p> Sin descripción </p>
               [[/description]]

               <i class="fa fa-tags"></i>

              [[#tags]]
              [[#.]]
              <span class="label label-info">#[[.]]</span>
              [[/.]]
              [[^.]]
              [[/.]]
              [[/tags]]

                              </div>

             <div class="card-footer">
                <button type="button" value="[[id]]" onclick='javascript:window.open("[[id]]", "_blank", "scrollbars=1,resizable=1,height=600,width=650");'  class="btn btn-primary"><i class="fa fa-eye"></i> </button>
                 <button type="button" value="[[id]]" onclick='get_activity("[[id]]","[[type]]")'  data-bs-toggle=""  data-bs-target="#"   data-bs-target="#confirm-edit" data-href="[[id]]" class="btn btn-primary"><i class="fa fa-cog"></i> </button>
                 <button type="button" value="[[id]]"  data-bs-toggle="modal"  data-bs-target="#confirm-delete"  data-href="[[id]]" class="btn btn-primary"><i class="fa fa-trash-o"></i></button>

            </div>
       </div>

  </div>
</script>







<script>

    $(function(){
        //if user deletes activity, modal shows
        $('#confirm-delete').on('show.bs.modal', function(e) {

            var value = ($(e.relatedTarget).data('href'));
            $('.debug-url').html('Delete activity: <strong>' + value + '? </strong>');
            $('.btn-ok').click(function(){
                delActivity(value);
                $('#confirm-delete').modal('hide');
            })

        });


    });





$('body').on('click', '.create-activity', function() {

      $('#modalChooseType').modal();
 });

    $('body').on('click', '#createActivityBtn', function(e){

        $('#modalCreateActivity').modal('hide');
    });

     $('body').on('click', '#htmlBtn', function(){
        var myModal = new bootstrap.Modal(document.getElementById('modalhtml'));
        myModal.show();
    });

     $('body').on('click', '#videoBtn', function(e){
        var myModal = new bootstrap.Modal(document.getElementById('modalvideo'));
        myModal.show();
     });


</script>



<script id="paginator_template" type="x-tmpsmustache">
    <ul class="pagination">

    [[#prev]]
     <li class="page-item" data-page='[[prevPage]]'>
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previo</span>
      </a>
    </li>

    [[/prev]]

       [[#pages]]
          [[#page]]
                <li class="page-item [[#active]]active[[/active]]" data-page=[[page]]><a class="page-link"  href="#">[[page]]</a></li>

          [[/page]]

          [[^.]]
          [[/.]]
       [[/pages]]

    [[#next]]
    <li class="page-item" data-page=[[nextPage]]>
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Siguiente</span>
      </a>
    </li>


    [[/next]]
 </ul>
</script>
 <script src="{{ STATIC_URL }}app/scripts/proto-main.js"></script>
<script type="text/javascript">










$(function(){
    buscar({ page:0, type: {'type': {'$in':['text','video','quiz','prog']}}})
});

//ajax function that sends query to server and displays results
function buscar(query){
        $.ajax({
        type: 'POST',
        url: '/search_prueba/',
        data: JSON.stringify(query),
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type)) {
                        var csrftoken = getCookie('csrftoken');
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
        success: function (data) {
            var obj = jQuery.parseJSON( data );
            if (obj == "null" || obj[0].count == 0){
                $("#paginator").empty();
                $("#actividades").append('<h3 style="color:lightgray">No hay actividades</h3>');
                count = 0
            }
            else{
                Mustache.tags = ['[[', ']]'];
                var activities_template = $('#activities_template').html();
                Mustache.parse(activities_template);
                $.each(obj, function( index, value ) {
                    if (value.count){
                        count = value.count
                    }
                    else{
                        rendered = Mustache.render(activities_template, {
                            title: value.title,
                            id: value._id,
                            icon:value.icon,
                            description: value.description,
                            lang:value.lang,
                            level:value.level,
                            type:value.type,
                            tags:value.tags,
                            image_url:value.image_url});
                        $("#actividades").append(rendered);
                    }
                });

                renderPaginator( query['page']+1, Math.floor((count + 20 -1)/20), 20, on_click );
                $('#actividades').val(data);

            }
        },
        error: function(data) {
            console.log("Error");
        }
    });
    }


$("#txtname").on('change', function(){
   $("#actividades").empty();
   $("#row").show();
    query_builder({ page:0, type: {'type': {'$in':['text','video','quiz','prog']}}, author: {'author': '{{user.email}}'}});
 });




var on_click = function(){
        var pagenum = $( this ).attr('data-page');
        $("#actividades").empty();
        var query =  load_query( "#txtname" ,{ page:pagenum - 1, type: {'type': {'$in':['text','video','quiz','prog']}}, author: {'author': '{{user.email}}'} });
    buscar(query);

    }




//function used when user deletes activity
function delActivity(activity){
    $.ajax({
        type: 'post',
        url: '/delete_activity/',
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type)) {
                        var csrftoken = getCookie('csrftoken');
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
        data: { _id: activity,
                user: '{{ user.email }}'},
        success: function (data){
            console.log(data);
            if (data == 1){
                alert("Actividad borrada");
                location.reload()
            }
            else{
                alert("Mal. La actividad no se ha borrado")
            }
        },
        error: function(data){
            alert("Error. La actividad no se ha borrado")
            console.log(data)
        }
    });
}

//function that gets activity info for updating activity
function get_activity(id,type){
    if (type == "prog"){
        load_dataProgram(id)
    }
    else if (type == "quiz"){
        load_dataQuiz(id)
    }
    else{
        $.ajax({
            type: 'get',
            url: '/get_id/',
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type)) {
                        var csrftoken = getCookie('csrftoken');
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
            data: { _id: id,
                user: '{{ user.email }}',
                type: type},
            success: function (data){
                var obj = jQuery.parseJSON( data );
                if (obj[0].type == "text"){
                    load_dataHtml(obj)
                }
                else if (obj[0].type == "video"){
                    load_dataVideo(obj)
                }

        },
        error: function(data){
            console.log(data)
        }
    });
    }

}

//loads activity data in html modal for updating
function load_dataHtml(obj){
    console.log("load html");

    //$('#modalhtml').modal();

    var myModal = new bootstrap.Modal(document.getElementById('modalhtml'));
    myModal.show();
    $.each(obj[0], function(key, value){
        if (key == 'content'){
            tinyMCE.get('content').setContent(value);
        }
        else if (key == 'tags'){
            $("#tagshtml").tagit("removeAll");
            for (var i=0; i < value.length ; i++){
                $("#tagshtml").tagit("createTag", value[i]);
            }
        }
        $('#formahtml [name='+key+']').val(value);
        $('#formadetail [name='+key+']').val(value);

    });
}

//loads activity data in video modal for updating
function load_dataVideo(obj){
    //$('#modalvideo').modal();
    var myModal = new bootstrap.Modal(document.getElementById('modalvideo'));
    myModal.show();

    $.each(obj[0], function(key, value){
        if (key == 'tags'){
            $("#tagsvideo").tagit("removeAll");
            for (var i=0; i < value.length ; i++){
                $("#tagsvideo").tagit("createTag", value[i]);
            }
        }
        $('#formaVideo [name='+key+']').val(value);
        $('#formadetailv [name='+key+']').val(value);

    });
    loadVideo();
}

//sends user to program update page
function load_dataProgram(id){
    window.location = '/build_program?id=' + id ;
}

//sends user to quiz update page
function load_dataQuiz(id){
    window.location = '/build_quiz?id=' + id ;
}


    $(function(){
//when user submits html form, this validates that some key values are provided, such as title and content of activity
        $('#_htmlActivity').click(function(e){
            var isValid = true;
            var title = $("#titleHtml").val();
            if (title == ''){
                isValid = false;
                $("#titleHtml").css("background-color", "#FFCECE");
            }
            else{
                $("#titleHtml").css("background-color", "");
            }
            //
            var content = tinymce.get('content').getContent();
            if (content==''){
                isValid=false;
                $(tinymce.activeEditor.getBody()).css("background-color",'#FFCECE');
            }
            else{
                $(tinymce.activeEditor.getBody()).css("background-color",'');
            }

            if (isValid == false){
                e.preventDefault();
                return false;
                }
            else {
                inserthtml();
                return false
            }
        });

        //when user submits video activity form, this validates that key values are provided
        $('#_videoActivity').click(function(e){
            var isValid = true;
            var startS = parseInt($("#startSeconds").val());
            var endS = parseInt($("#endSeconds").val());
            $('#formaVideo')
                    .find('input[type="text"]')
                    .filter(":not(.ui-widget-content)")
                    .filter(":not(.input-optional)")
                    .each(function () {
                        if ($.trim($(this).val()) == '') {
                            isValid = false;
                            $(this).css({
                                "border": "1px solid red",
                                "background": "#FFCECE"
                            });
                        }
                        else {
                            $(this).css({
                                "border": "",
                                "background": ""
                            });
                        }
                    });

            if (startS >= endS){
                isValid = false;
                alert("Tiempo de inicio debe ser menor al tiempo de fin del video.")
            }

            if (isValid == false){
                e.preventDefault();
                return false;
                }
            else {
                insertvideo();
                return false
            }
        });

        //resets forms such as html and video when modal closes
        $(".modal").on("hidden.bs.modal", function(){
            $("#tagshtml").tagit("removeAll");
            $("#tagsvideo").tagit("removeAll");
            $('#formahtml')[0].reset();
            $('#formadetail')[0].reset();
            $('#formaVideo')[0].reset();
            $('#formadetailv')[0].reset();
            $('#ytVideo').empty();
        });

        //loads loadVideo function when url of video is provided by user
        $('#url').on('change', loadVideo);



    });

    //function that gets all data from html forms and send it to server, if activity exists, it updates it
    function inserthtml(){
        tinyMCE.triggerSave();
        var main= $('#formahtml').serializeArray();
        var detail = $('#formadetail').serializeArray();
        var data = main.concat(detail);
        data = indexdata(data);
        console.log(data);
        var current = window.location.pathname;
        $.ajax({
            type: 'post',

            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type)) {
                            var csrftoken = getCookie('csrftoken');
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    },
            url: '/upload_activity/',
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (info){
                info = jQuery.parseJSON(info);
                if (info.updatedExisting == true){
                    alert("Actividad modificada");
                    $('#formahtml')[0].reset();
                    $("#tagshtml").tagit("removeAll");
                    $('#formadetail')[0].reset();
                    $("#modalhtml").modal('hide');
                    if (current == '/activitybuilder'){
                        location.reload()
                    }
                }
                else if (info.updatedExisting == false){
                    alert("Actividad agregada");
                    $('#formahtml')[0].reset();
                    $("#tagshtml").tagit("removeAll");
                    $('#formadetail')[0].reset();
                    $("#modalhtml").modal('hide');
                    if (current == '/activitybuilder'){
                        location.reload()
                    }
                }
                else if (info.message == "Duplicated"){
                    alert("Duplicated Entry");
                    $('#formahtml')[0].reset();
                    $("#tagshtml").tagit("removeAll");
                    $('#formadetail')[0].reset();
                    $("#modalhtml").modal('hide');
                    if (current == '/activitybuilder'){
                        location.reload()
                    }
                }
            },
            error: function(info){
                if (info){
                    if (data.name == 'errmsg' && data.code== 11000){
                        alert("Error. Intente otro nombre para su actividad");
                    }
                    return alert("Error. La actividad no se agregó")
                }

            }
        });

    }

    //function that gets all data from video forms and sends it to the server for insertion, if id exists, it will update activity
    function insertvideo(){
        var main= $('#formaVideo').serializeArray();
        var detail = $('#formadetailv').serializeArray();
        var data = main.concat(detail);
        data = indexdata(data);
        var current = window.location.pathname;
        console.log(data);
        $.ajax({
            type: 'post',
            url: '/upload_activity/',
            contentType: "application/json",
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type)) {
                            var csrftoken = getCookie('csrftoken');
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    },

            data: JSON.stringify(data),
            success: function (info) {
                info = jQuery.parseJSON(info);
                if (info.updatedExisting == true){
                    alert("Actividad modificada");
                    $('#formaVideo')[0].reset();
                    $("#tagsvideo").tagit("removeAll");
                    $("#modalvideo").modal('hide');
                    $("#ytVideo").empty();
                    if (current == '/activitybuilder'){
                        location.reload()
                    }
                }
                else if (info.updatedExisting == false){
                    alert("Actividad agregada");
                    $('#formaVideo')[0].reset();
                    $("#tagsvideo").tagit("removeAll");
                    $("#modalvideo").modal('hide');
                    $("#ytVideo").empty();
                    if (current == '/activitybuilder'){
                        location.reload()
                    }
                }
                else if (info.message == "Duplicated"){
                    alert("Duplicated Entry");
                    $('#formaVideo')[0].reset();
                    $("#tagsvideo").tagit("removeAll");
                    $("#modalvideo").modal('hide');
                    $("#ytVideo").empty();
                    if (current == '/activitybuilder'){
                        location.reload()
                    }
                }
            },
            error: function(info) {
                   alert(info)
            }
        });
    }

    //function that receives data from all types of insert activities, and returns data stored in a dictionary with key and value for easy conversion to json


    //function used to check if title of activities already exist in db, if it exists, user is prompted with a warning message
   function check(valor){
       $.ajax({
           type: 'get',
           url: '/get_activity/',
           data: { valor: valor},
           crossDomain: false, // obviates need for sameOrigin test
           beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type)) {
                            var csrftoken = getCookie('csrftoken');
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    },

           success: function (data) {
               var obj =jQuery.parseJSON(data);
               if (jQuery.isEmptyObject(obj)){
                   console.log("No existe");
               }
               else{
                   alert("Nombre de actividad ya existe");
               }
           },
           error: function (data){
               console.log("Error")
           }
       });

   }

    //function used when user inputs a youtube url, load video in iframe
    function loadVideo() {
        var url = $('#url').val();
        var p = /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/;
        if ((url.match(p)) == null){
            if (url == ''){
                $('#ytVideo').empty()
            }
            else{
                alert("URL invalida");
                $('#ytVideo').empty()
            }
        }
        else{
            var urlchange = url.replace('https://www.youtube.com/watch?v=', 'http://www.youtube.com/embed/');
            var vid_id=url.replace('https://www.youtube.com/watch?v=','');
            $('#youtube_id').val(vid_id);
            var htm = '<iframe width="425" height="300" src="' + urlchange + '?rel=0" frameborder="0" allowfullscreen ></iframe>';
            $('#ytVideo').html(htm);
            return false;
        }

    }

    //function used when user inputs a youtube url, load video in iframe
    function loadImage() {
        var url = $('#image_url').val();
        var p = /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/;
        if ((url.match(p)) == null){
            if (url == ''){
                $('#ytVideo').empty()
            }
            else{
                alert("URL invalida");
                $('#ytVideo').empty()
            }
        }
        else{
            var urlchange = url.replace('https://www.youtube.com/watch?v=', 'http://www.youtube.com/embed/');
            var vid_id=url.replace('https://www.youtube.com/watch?v=','');
            $('#youtube_id').val(vid_id);
            var htm = '<iframe width="425" height="300" src="' + urlchange + '?rel=0" frameborder="0" allowfullscreen ></iframe>';
            $('#ytVideo').html(htm);
            return false;
        }

    }



//loads dropdown menu from another dropdown menu (Crear menu)
    (function ($) {
    $(document).ready(function () {
        $('ul.dropdown-menu [ data-bs-toggle=dropdown]').on('click', function (event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).parent().siblings().removeClass('open');
            $(this).parent().toggleClass('open');
        });
    });
    })(jQuery);

    (function($){
    $(document).ready(function () {
        var user = '{{ user }}';
        if(user =='AnonymousUser')  {
            $('#_htmlActivity').attr("disabled",true);
            $('#_videoActivity').attr("disabled",true);
        }
        else {
            $('#_htmlActivity').removeAttr("disabled");
            $('#_videoActivity').removeAttr("disabled");
        }

    });
    })(jQuery);

    //initializes tagit plugin for tag input
    $(document).ready(function() {
        $("#tagshtml").tagit({
            fieldName: "tags"
        });

        $("#tagsvideo").tagit({
            fieldName: "tags"
        });




        $("#txttags").tagit({
            fieldName: "tags"
        });
    });

</script>


{% endblock %}

