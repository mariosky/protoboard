{% extends "activitytree/base.html" %}

{% block content %}
 <!--Instructor Header BEGIN -->


      <!--Instructor TABS -->
<div  class="row instructor-tab">


        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link " href="/instructor">Mis Cursos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/activitybuilder">Mis Actividades</a>
          </li>
        </ul>
</div>

 <!--Instructor Menu -->

     <div class="container">
            <row>
                <nav class="navbar navbar-light bg-faded">
                           <ul class="nav navbar-nav">

                             <li class="nav-item dropdown active">

                                          <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Nueva Actividad
                                          </button>
                                            <ul class="dropdown-menu" id="sidebar">
                                                <li><a class="dropdown-item" href="#" id="htmlBtn">HTML</a></li>
                                                <li><a class="dropdown-item" href="#" id="videoBtn">Video</a></li>
                                                <li><a class="dropdown-item" href="/build_quiz">Quiz</a></li>
                                                <li><a class="dropdown-item" href="/build_program">Program</a></li>
                                            </ul>
                              </li>

                          <form class="form-inline pull-right" role="search" onsubmit="return false">
                            <input class="form-control" type="text" placeholder="Search by Title or #Tag" name="srch-term" id="txtname">
                            <button class="btn btn-outline-success" type="submit">Search</button>
                          </form>

                           </ul>
                      </nav>
            </row>
    </div>

 <!--Instructor Header END -->




    <div class="container" id="actividades" >

    </div>
   <nav aria-label="Page navigation" id="paginator" align="center">


    </nav>


    <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" align="center" style="font-size: large">
                Alert <i class="fa fa-exclamation-circle"></i>
            </div>
            <div class="modal-body" align="center">
               <h5> Message <p class="debug-url"></p> </h5>
            </div>
            <div class="modal-footer" >
                <div class="form-group" align="center">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <a class="btn btn-danger btn-ok">Delete</a>
                </div>
            </div>
        </div>
    </div>
</div>






{% endblock %}

{% block scripts %}

<script id="activities_template" type="x-tmpl-mustache">

       <div class="col-sm-6">
          <div class="card">
          <div class="card-block">
            <h4 class="card-title">
              <i class="fa fa-[[icon]]"> </i> [[title]]
             </h4>
               [[#description]]
                   <p> [[description]]</p>
               [[ /description ]]
               [[^description]]
                  <p> Sin descripci√≥n </p>
               [[/description]]

               <i class="fa fa-tags"></i>

              [[#tags]]
              [[#.]]
              <span class="label label-info">#[[.]]</span>
              [[/.]]
              [[^.]]
              [[/.]]
              [[/tags]]

                              </div>

             <div class="card-footer">
                <button type="button" value="[[id]]" onclick='javascript:window.open("[[id]]", "_blank", "scrollbars=1,resizable=1,height=600,width=650");'  class="btn btn-primary"><i class="fa fa-eye"></i> </button>
                 <button type="button" value="[[id]]" onclick='get_activity("[[id]]","[[type]]")' data-toggle="" data-target="#"  data-target="#confirm-edit" data-href="[[id]]" class="btn btn-primary"><i class="fa fa-cog"></i> </button>
                 <button type="button" value="[[id]]" data-toggle="modal" data-target="#confirm-delete"  data-href="[[id]]" class="btn btn-primary"><i class="fa fa-trash-o"></i></button>

            </div>
       </div>

  </div>
</script>

<script>

    $(function(){
        //if user deletes activity, modal shows
        $('#confirm-delete').on('show.bs.modal', function(e) {

            var value = ($(e.relatedTarget).data('href'));
            $('.debug-url').html('Delete activity: <strong>' + value + '? </strong>');
            $('.btn-ok').click(function(){
                delActivity(value);
                $('#confirm-delete').modal('hide');
            })

        });


    });

</script>



<script id="paginator_template" type="x-tmpl-mustache">
    <ul class="pagination">

    [[#prev]]
     <li class="page-item" data-page='[[prevPage]]'>
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>

    [[/prev]]

       [[#pages]]
          [[#page]]
                <li class="page-item [[#active]]active[[/active]]" data-page=[[page]]><a class="page-link"  href="#">[[page]]</a></li>

          [[/page]]

          [[^.]]
          [[/.]]
       [[/pages]]

    [[#next]]
    <li class="page-item" data-page=[[nextPage]]>
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>


    [[/next]]
 </ul>
</script>
 <script src="{{ STATIC_URL }}app/scripts/main.js"></script>
<script type="text/javascript">










$(function(){
    buscar({ page:0, type: {'type': {'$in':['text','video','quiz','prog']}}, author: {'author': '{{user.email}}'}})
});

//ajax function that sends query to server and displays results
function buscar(query){
        $.ajax({
        type: 'POST',
        url: '/search_prueba',
        data: JSON.stringify(query),
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type)) {
                        var csrftoken = getCookie('csrftoken');
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
        success: function (data) {
            var obj = jQuery.parseJSON( data );
            if (obj == "null" || obj[0].count == 0){
                $("#paginator").empty();
                $("#actividades").append('<h3 style="color:lightgray">No hay actividades</h3>');
                count = 0
            }
            else{
                Mustache.tags = ['[[', ']]'];
                var activities_template = $('#activities_template').html();
                Mustache.parse(activities_template);
                $.each(obj, function( index, value ) {
                    if (value.count){
                        count = value.count
                    }
                    else{
                        rendered = Mustache.render(activities_template, {
                            title: value.title,
                            id: value._id,
                            icon:value.icon,
                            description: value.description,
                            lang:value.lang,
                            level:value.level,
                            type:value.type,
                            tags:value.tags});
                        $("#actividades").append(rendered);
                    }
                });

                renderPaginator( query['page']+1, Math.floor((count + 10 -1)/10), 10, on_click );
                $('#actividades').val(data);

            }
        },
        error: function(data) {
            console.log("Error");
        }
    });
    }


$("#txtname").on('change', function(){
   $("#actividades").empty();
   $("#row").show();
    query_builder({ page:0, type: {'type': {'$in':['text','video','quiz','prog']}}, author: {'author': '{{user.email}}'}});
 });




var on_click = function(){
        var pagenum = $( this ).attr('data-page');
        $("#actividades").empty();
        var query =  load_query( "#txtname" ,{ page:pagenum - 1, type: {'type': {'$in':['text','video','quiz','prog']}}, author: {'author': '{{user.email}}'} });
    buscar(query);

       // buscar({ page:pagenum - 1, type: {'type': {'$in':['text','video','quiz','prog']}}, author: {'author': '{{user.email}}'}});
    }




//function used when user deletes activity
function delActivity(activity){
    $.ajax({
        type: 'post',
        url: '/delete_activity',
        data: { _id: activity,
                user: '{{ user.email }}'},
        success: function (data){
            if (data == "okn"){
                alert("Actividad borrada");
                location.reload()
            }
            else{
                alert("Error")
            }
        },
        error: function(data){
            console.log(data)
        }
    });
}

//function that gets activity info for updating activity
function get_activity(id,type){
    if (type == "prog"){
        load_dataProgram(id)
    }
    else if (type == "quiz"){
        load_dataQuiz(id)
    }
    else{
        $.ajax({
            type: 'get',
            url: '/get_id',
            data: { _id: id,
                user: '{{ user.email }}',
                type: type},
            success: function (data){
                var obj = jQuery.parseJSON( data );
                if (obj[0].type == "text"){
                    load_dataHtml(obj)
                }
                else if (obj[0].type == "video"){
                    load_dataVideo(obj)
                }

        },
        error: function(data){
            console.log(data)
        }
    });
    }

}

//loads activity data in html modal for updating
function load_dataHtml(obj){
    $('#modalhtml').modal();
    $.each(obj[0], function(key, value){
        if (key == 'content'){
            tinyMCE.get('content').setContent(value);
        }
        else if (key == 'tags'){
            $("#tagshtml").tagit("removeAll");
            for (var i=0; i < value.length ; i++){
                $("#tagshtml").tagit("createTag", value[i]);
            }
        }
        $('#formahtml [name='+key+']').val(value);
        $('#formadetail [name='+key+']').val(value);

    });
}

//loads activity data in video modal for updating
function load_dataVideo(obj){
    $('#modalvideo').modal();
    $.each(obj[0], function(key, value){
        if (key == 'tags'){
            $("#tagsvideo").tagit("removeAll");
            for (var i=0; i < value.length ; i++){
                $("#tagsvideo").tagit("createTag", value[i]);
            }
        }
        $('#formaVideo [name='+key+']').val(value);
        $('#formadetailv [name='+key+']').val(value);

    });
    loadVideo();
}

//sends user to program update page
function load_dataProgram(id){
    window.location = '/build_program?id=' + id ;
}

//sends user to quiz update page
function load_dataQuiz(id){
    window.location = '/build_quiz?id=' + id ;
}



</script>

{% endblock %}

