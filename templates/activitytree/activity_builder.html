{% extends "activitytree/base.html" %}

{% block content %}
 <!--Instructor Header BEGIN -->






      <!--Instructor TABS -->
<div  class="row instructor-tab">


        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link " href="/instructor">Mis Cursos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/activitybuilder">Mis Actividades</a>
          </li>
        </ul>
</div>

 <!--Instructor Menu -->

     <div class="container">
            <row>
                <nav class="navbar navbar-light bg-faded">
                           <ul class="nav navbar-nav">

                             <li class="nav-item dropdown active">

                                          <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Nueva Actividad
                                          </button>
                                            <ul class="dropdown-menu" id="sidebar">
                                                <li><a class="dropdown-item" href="#" id="htmlBtn">HTML</a></li>
                                                <li><a class="dropdown-item" href="#" id="videoBtn">Video</a></li>
                                                <li><a class="dropdown-item" href="/build_quiz">Quiz</a></li>
                                                <li><a class="dropdown-item" href="/build_program">Program</a></li>
                                            </ul>
                              </li>

                          <form class="form-inline pull-right" role="search" onsubmit="return false">
                            <input class="form-control" type="text" placeholder="Search by Title or #Tag" name="srch-term" id="txtname">
                            <button class="btn btn-outline-success" type="submit">Search</button>
                          </form>

                           </ul>
                      </nav>
            </row>
    </div>

 <!--Instructor Header END -->


   <nav aria-label="Page navigation" id="pagor">


    </nav>

    <div class="container" id="actividades" >

    </div>



    <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" align="center" style="font-size: large">
                Alert <i class="fa fa-exclamation-circle"></i>
            </div>
            <div class="modal-body" align="center">
               <h5> Message <p class="debug-url"></p> </h5>
            </div>
            <div class="modal-footer" >
                <div class="form-group" align="center">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <a class="btn btn-danger btn-ok">Delete</a>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}

<script type="text/javascript" src="{{ STATIC_URL }}app/scripts/jquery.bootpag.js"></script>


<script id="activities_template" type="x-tmpl-mustache">

       <div class="col-sm-6">
          <div class="card">
          <div class="card-block">
            <h4 class="card-title">

              <i class="fa fa-[[icon]]"> </i> [[title]]


             </h4>





                              [[#description]]
                   <p> [[description]]</p>
               [[ /description ]]
               [[^description]]
                  <p> Sin descripción </p>
               [[/description]]

                 <i class="fa fa-tags"></i>

              [[#tags]]
              [[#.]]
              <span class="label label-info"><a href="/search/?tag=[[.]]" style="color:#FFFFFF">[[.]]</a></span>
              [[/.]]
              [[^.]]
              [[/.]]
              [[/tags]]


                              </div>

             <div class="card-footer">
                <button type="button" value="[[id]]" onclick='javascript:window.open("[[id]]", "_blank", "scrollbars=1,resizable=1,height=600,width=650");'  class="btn btn-primary"><i class="fa fa-eye"></i> </button>
                 <button type="button" value="[[id]]" onclick='get_activity("[[id]]","[[type]]")' data-toggle="" data-target="#"  data-target="#confirm-edit" data-href="[[id]]" class="btn btn-primary"><i class="fa fa-cog"></i> </button>
                 <button type="button" value="[[id]]" data-toggle="modal" data-target="#confirm-delete"  data-href="[[id]]" class="btn btn-primary"><i class="fa fa-trash-o"></i></button>

            </div>
       </div>

  </div>
</script>

<script>

    $(function(){
        //if user deletes activity, modal shows
        $('#confirm-delete').on('show.bs.modal', function(e) {
            console.log(e);
            var value = ($(e.relatedTarget).data('href'));
            console.log(value);
            $('.debug-url').html('Delete activity: <strong>' + value + '? </strong>');

            $('.btn-ok').click(function(){
                delActivity(value);
                $('#confirm-delete').modal('hide');
            })

        });


    });

</script>


<script id="activities_template" type="x-tmpl-mustache">

       <div class="col-sm-6">
          <div class="card">
          <div class="card-block">
            <h4 class="card-title">

              <i class="fa fa-[[icon]]"> </i> [[title]]


             </h4>

               [[#description]]
                   <p> [[description]]</p>
               [[ /description ]]
               [[^description]]
                  <p> Sin descripción </p>
               [[/description]]

                 <i class="fa fa-tags"></i>

              [[#tags]]
              [[#.]]
              <span class="label label-info"><a href="/search/?tag=[[.]]" style="color:#FFFFFF">[[.]]</a></span>
              [[/.]]
              [[^.]]
              [[/.]]
              [[/tags]]


                              </div>

             <div class="card-footer">
                <button type="button" value="[[id]]" onclick='javascript:window.open("[[id]]", "_blank", "scrollbars=1,resizable=1,height=600,width=650");'  class="btn btn-primary"><i class="fa fa-eye"></i> </button>
                 <button type="button" value="[[id]]" onclick='get_activity("[[id]]","[[type]]")' data-toggle="" data-target="#"  data-target="#confirm-edit" data-href="[[id]]" class="btn btn-primary"><i class="fa fa-cog"></i> </button>
                 <button type="button" value="[[id]]" data-toggle="modal" data-target="#confirm-delete"  data-href="[[id]]" class="btn btn-primary"><i class="fa fa-trash-o"></i></button>

            </div>
       </div>

  </div>
</script>

<script id="paginator_template" type="x-tmpl-mustache">
    <ul class="pagination">

    [[#prev]]
     <li class="page-item">
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>

    [[/prev]]

       [[#pages]]
          [[#page]]
                <li class="page-item [[#active]]active[[/active]]"><a class="page-link" href="#">[[page]]</a></li>

          [[/page]]

          [[^.]]
          [[/.]]
       [[/pages]]

    [[#next]]
    <li class="page-item">
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>

    </ul>
    [[/next]]

</script>

<script type="text/javascript">
var param = [];
var tags = [];
var query = {};
query['page'] = 0;
var initialize = ['text','video','quiz','prog'];
query['type'] = {'type': {'$in':initialize}};
query['author'] = {'author': '{{user.email}}'};




var getPages =  function( page , total, maxVisible )
    {
        //number of pages to each side of the current page
        var eachSide = Math.floor( maxVisible/2);

        // extra pages gained if page is to close to one of the sides
        var leftExtra = 0;
        var rightExtra = 0;

        //minimum page on the left
        var leftPage = page - eachSide;


        if (leftPage < 1)
        {
             leftExtra = (leftPage * -1)+1;
             leftPage = 1;

        }

        var rightPage = page + eachSide;

        if (rightPage > total )
        {
            rightExtra = total - rightPage;
            rightPage = total;
        }
        //console.log([leftExtra,rightExtra, leftPage,rightPage])

        //Lets check if we can use the extra pages
        //Extra Left
        leftPage+=rightExtra;
        if (leftPage < 1)
        {
             leftPage = 1;

        }

        //Extra Right
        rightPage+=leftExtra;
        if (rightPage > total )
        {
             rightPage = total;

        }

        //Pages
        var pages = [];

        for (var i = 0 ; i <= rightPage-rightExtra; i++ )
        {

            pages[i]= { page:leftPage, active:leftPage==page} ;
            leftPage++;

            if (leftPage > rightPage)
                    break;

        }
        var prev =  leftPage > 1 ;
        var next =  rightPage < total ;



        return { prev:prev , next:next, pages: pages  } ;

    }





console.log( "9,2,14,15,1");

console.log( getPages(9,15,5));
console.log( getPages(2,15,5));
console.log( getPages(14,15,5));
console.log( getPages(15,15,5));
console.log( getPages(1,15,5));
console.log( getPages(1,1,5));

 Mustache.tags = ['[[', ']]'];
 var paginator_template = $('#paginator_template').html();
 Mustache.parse(paginator_template);
 var pages = getPages(9,15,5);
 rendered = Mustache.render(paginator_template, {
                pages: pages.pages,
                next:pages.next,
                prev:pages.prev

                });
console.log(rendered);

                $("#pagor").append(rendered);











//paginator plugin initialize
$(function(){
    page = 0;
    $('#paginator').bootpag({
            total: 1,
            page: 1,
            activeClass:"page-item active",
            disabledClass:"page-item"

        }).on("page", function(event, num){
            $("#actividades").empty();
            query['page'] = (5) * (num - 1) ;
            buscar(query);
            $(this).bootpag({total: Math.floor((count + 5 -1)/5), maxVisible: 10});
        });
    buscar(query)
});




//function used when user deletes activity
function delActivity(activity){
    $.ajax({
        type: 'post',
        url: '/delete_activity',
        data: { _id: activity,
                user: '{{ user.email }}'},
        success: function (data){
            if (data == "okn"){
                alert("Actividad borrada");
                location.reload()
            }
            else{
                alert("Error")
            }
        },
        error: function(data){
            console.log(data)
        }
    });
}

//function that gets activity info for updating activity
function get_activity(id,type){

    if (type == "prog"){
        load_dataProgram(id)
    }
    else if (type == "quiz"){
        load_dataQuiz(id)
    }
    else{
        $.ajax({
            type: 'get',
            url: '/get_id',
            data: { _id: id,
                user: '{{ user.email }}',
                type: type},
            success: function (data){
                var obj = jQuery.parseJSON( data );
                if (obj[0].type == "text"){
                    load_dataHtml(obj)
                }
                else if (obj[0].type == "video"){
                    load_dataVideo(obj)
                }

        },
        error: function(data){
            console.log(data)
        }
    });
    }

}

//loads activity data in html modal for updating
function load_dataHtml(obj){
    $('#modalhtml').modal();
    $.each(obj[0], function(key, value){
        if (key == 'content'){
            tinyMCE.get('content').setContent(value);
        }
        else if (key == 'tags'){
            $("#tagshtml").tagit("removeAll");
            for (var i=0; i < value.length ; i++){
                $("#tagshtml").tagit("createTag", value[i]);
            }
        }
        $('#formahtml [name='+key+']').val(value);
        $('#formadetail [name='+key+']').val(value);

    });
}

//loads activity data in video modal for updating
function load_dataVideo(obj){
    $('#modalvideo').modal();
    $.each(obj[0], function(key, value){
        if (key == 'tags'){
            $("#tagsvideo").tagit("removeAll");
            for (var i=0; i < value.length ; i++){
                $("#tagsvideo").tagit("createTag", value[i]);
            }
        }
        $('#formaVideo [name='+key+']').val(value);
        $('#formadetailv [name='+key+']').val(value);

    });
    loadVideo();
}

//sends user to program update page
function load_dataProgram(id){
    window.location = '/build_program?id=' + id ;
}

//sends user to quiz update page
function load_dataQuiz(id){
    window.location = '/build_quiz?id=' + id ;
}

        $('#difficulty li').click(function () {
            $('#difficulty li').not(this).removeClass('active');
            $(this).addClass('active');
        });

        $('#lang li').click(function () {
            $('#lang li').not(this).removeClass('active');
            $(this).addClass('active');
        });

        $("#difficulty a[class='small']").on('click',function(){
            var param = this.getAttribute('data-value');
            $("#actividades").empty();
            if (param == 'any'){
                param = "";
            }
            query_builder("level",param,query)
        });

        $("#lang a[class='small']").on('click',function(){
            var param = this.getAttribute('data-value');
            $("#actividades").empty();
            if (param == 'any'){
                param = "";
            }
            query_builder("lang",param,query)
        });

        $("#sidebar input[type='checkbox']").change(function(){
            if(this.checked){
                $("#actividades").empty();
                param.push(this.value);
                query_builder("type",param,query)
            }
            else
            {
                $("#actividades").empty();
                param.splice($.inArray(this.value,param), 1);
                if (param.length == 0){
                    var initialize = ['text','video','quiz','prog'];
                    query_builder("type",initialize,query)
                }
                else{
                    query_builder("type",param,query)
                }

            }
        });

        $("#txtname").on('change', function(){
            $("#actividades").empty();
            $("#row").show();
            query_builder("name",param,query);
        });

        $("#txtdifficulty").on('change', function(){
            $("#actividades").empty();
            query_builder("level",param,query)
        });

        $("#txtlang").on('change', function(){
            $("#actividades").empty();
            query_builder("lang",param,query)
        });

//clears all inputs from user and reinitializes query when Clear All is clicked
        $("#clear").click(function(){
            query = {};
            param =[];
            initialize = ['text','video','quiz','prog'];
            query['author'] = {'author': '{{user.email}}'};
            $('#lang li').not($("#lang li[id='anylang']")).removeClass('active');
            $('#difficulty li').not($("#lang li[id='anylevel']")).removeClass('active');
            $("#actividades").empty();
            $("#txtname").val('');
            $("#txtuser").val('');
            $("#sidebar input[type='checkbox']").prop('checked', false);
            query_builder("type",initialize,query);
        });

//function that builds a query depending on input of user
function query_builder(flag,param,query)
    {
        if (flag == "type"){
            if (param.length==0){
                delete query["type"];
                buscar(query)
            }
            else{
                query['type'] = {'type': {'$in':param}};
                buscar(query)
            }
        }
        else if (flag == "name"){
            if ($("#txtname").val() == ""){
                delete query["title"];
                delete query["tags"];
                buscar(query)
            }
            else{
                var name = $("#txtname").val();
                var exp_tags = /S*#(?:\[[^\]]+\]|\S+)/;
                if (exp_tags.test(name)){
                    var texto = name.split(/\s+/g);
                    tags = [];
                    title = [];
                    for(var i=0;i<texto.length;i++){
                        if(texto[i].match(exp_tags)){
                            tags.push(texto[i].replace('#',''))
                        }
                        else{
                            title.push(texto[i])
                        }
                    }
                    title = title.join(" ");
                    if (title != "" && tags.length != 0){
                        query['title'] = {'title': {'$regex': title, '$options': 'i'}};
                        query['tags'] = {'tags': {'$all': tags}};
                    }
                    else if (tags.length != 0 && title == ""){
                        query['tags'] = {'tags': {'$all': tags}};
                        delete query['title']
                    }
                    else if (tags.length == 0 && title != ""){
                        query['title'] = {'title': {'$regex': title, '$options': 'i'}};
                        delete query['tags']
                    }
                    else{
                        delete query['title'];
                        delete query['tags']
                    }
                    buscar(query)
                }
                else{
                    query['title'] = {'title': {'$regex': $("#txtname").val(), '$options': 'i'}};
                    delete query['tags'];
                    buscar(query)
                }

            }
        }
        else if (flag == "level"){
            if (param == ""){
                delete query["level"];
                buscar(query)
            }
            else{
                query['level'] = {'level': param};
                buscar(query)
            }
        }
        else if (flag == "lang"){
            if (param == ""){
                delete query["lang"];
                buscar(query)
            }
            else{
                query['lang'] = {'lang': param};
                buscar(query)
            }
        }
    }

//ajax function that sends query to server and displays results
function buscar(tipo){
        $.ajax({
        type: 'POST',
        url: '/search_prueba',
        data: JSON.stringify(tipo),
        success: function (data) {
            var obj = jQuery.parseJSON( data );
            if (obj == "null" || obj[0].count == 0){
                $("#paginator").hide();
                $("#actividades").append('<h3 style="color:lightgray">No hay actividades</h3>');
                //alert("No se encontro actividad con esas caracteristicas");
                count = 0
            }
            else{
                Mustache.tags = ['[[', ']]'];
                var activities_template = $('#activities_template').html();
                Mustache.parse(activities_template);
                $.each(obj, function( index, value ) {
                    if (value.count){
                        count = value.count
                    }
                    else{
                        rendered = Mustache.render(activities_template, {
                            title: value.title,
                            id: value._id,
                            icon:value.icon,
                            description: value.description,
                            lang:value.lang,
                            level:value.level,
                            type:value.type,
                            tags:value.tags});
                        $("#actividades").append(rendered);
                    }
                });
                $("#paginator").show();
                $("#paginator").bootpag({total: Math.floor((count + 5 -1)/5), maxVisible: 10});
                $('#actividades').val(data);

            }
        },
        error: function(data) {
            console.log("Error");
        }
    });
    }


</script>

{% endblock %}

