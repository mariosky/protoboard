{% extends 'activitytree/base.html' %}



{% block style %}

/*
 * Editor
 */

    #editor1 {

        height: 340px;
        width: 200;

    }

    #editor2{

        height: 340px;
        width: 200;

    }

    #editor3{
        height: 340px;
        width: 200;
    }

 p.test_error, p.test_failure {
    color:#d9534f;
    }

 p.test_success{
    color:#5cb85c;
    }

  .alert{
    margin:10px;
    margin-bottom:0px;
    }


{% endblock style %}



{% block content %}

<div class="container" style="width: 100%">
  <h3>Menu</h3>
  {% if d %}
       {{ title }}
  {% endif %}
  <ul class="nav nav-tabs">
    <li class="active"><a href="#info" data-toggle="tab">Info</a> </li>
    <li><a href="#programa" data-toggle="tab">Programa</a></li>
  </ul>
  <br>

    <div class="tab-content" style="width: 100%">
        <div class="tab-pane fade in active" id="info">
            <div class="container-fluid" style="float: left; width: 45%">
            <form id="formaProg" class="form-group" onsubmit="return false">
                <label for="displayprog">Display Name</label>
                <input type="text" id="displayprog" name="title" class="form-control">
                <label for="idprog">ID</label>
                <input type="text" readonly="readonly" class="form-control" id="idprog" name="_id">
                <label for="descriptionprog">Description</label>
                <input type="text" class="form-control" id="descriptionprog" name="description">
                <label for="rightsprog">Rights</label>
                <input type="hidden" name="type" value="prog">
                <input type="hidden" name="author" value="{{ user.email }}">
                <input type="text" class="form-control" id="rightsprog" name="rights">
                <label for="externalprog">External URL</label>
                <input type="text" class="form-control" id="externalprog" name="external_url">
                <label for="publisherprog">Publisher</label>
                <input type="text" class="form-control" id="publisherprog" name="publisher">
                <label for="tagsprog">Tags</label>
                <input class="form-control" id="tagsprog" name="tags"><br>
                <label for="iconprog">Icon</label>
                <select id="iconprog" name="icon" >
                    <option value="coffee">Coffee</option>
                    <option value="file">File</option>
                    <option value="youtube-play">Youtube</option>
                    <option value="puzzle-piece">Puzzle</option>
                </select>
                <label for="levelprog">Level</label>
                <select id="levelprog" name="level">
                    <option value="principiante">Principiante</option>
                    <option value="intermedio">Intermedio</option>
                    <option value="avanzado">Avanzado</option>
                </select><br>
                <input type="submit" class="btn btn-primary" id="submitProg" value="Save">
                <input type="button" class="btn btn-default" id="cancelProg" value="Cancel">
            </div>
            <div class="" style="margin-left: 50%; height: 50%">
                <label for="editor1">Ayuda avanzada</label>
                <tinytext name="content" id="html"></tinytext>
            </div>
            </form>
        </div>



        <div class="tab-pane fade" id="programa" >

            <div style="float: left;width: 33.3%">
            <label for="editor1">Unit Test</label>
            <div class="myeditor" id="editor1">
function foo(items) {
Unit test;
return x;}
            </div>
            </div>

            <div style="float: right; width: 33.3%">
            <label for="editor2">Correct Code</label>
                <div class="myeditor" id="editor2">
function foo(items) {
Correct code;
return x;}
                </div>
            </div>

                <div style="float: left; width: 33.3%">
                    <label for="editor3">Initial Code</label>
                    <div class="myeditor" id="editor3">
function foo(items){
Initial code;
}
                    </div>
                </div>


            <div class="container">
                <div style="float:left;width: 35%">
                <form id="formadetailp" onsubmit="return false">
                <label for="txtLang">Elija lenguaje de programacion:</label>
                <select id="txtLang" name="lang" class="form-control">
                    <option value="javascript">Javascript</option>
                    <option value="csharp">Csharp</option>
                    <option value="python">Python</option>
                    <option value="java">Java</option>
                </select>
                <input type="button" id="probarProg" class="btn btn-primary" value="Test">
                </div>

                <div style="margin-left: 40%; width: 50%">
                    <label for="txtInstrucciones">Instrucciones: </label>
                    <textarea class="form-control" id="txtInstrucciones" name="instructions" rows="3" ></textarea>
                </div>
                </form>
                </div>

            </div>

        </div>
    </div>
</div>

<div id="confirmProg" class="modal fade">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header" align="center">
            Confirmar <i class="fa fa-upload"></i>
        </div>
        <div class="modal-body">
            Seguro que quieres subir la actividad?
        </div>
        <div class="modal-footer">
            <button type="button" data-dismiss="modal" class="btn btn-primary" id="acceptBtn">Aceptar</button>
            <button type="button" data-dismiss="modal" class="btn">Cancelar</button>
        </div>
    </div>
</div>
</div>


{% endblock %}


{% block scripts %}

    <script>
    $(document).ready(function(){
        var url = getParameterByName('id');
        if (url != null){
            var type = 'prog';
            $("#tagsprog").tagit("removeAll");
            get_activity(url,type);
        }
        else {
            console.log(url)
        }
    });


    $(function(){

        $('#displayprog').on('change', function(){
            var id = '/program/' + this.value.replace(/ /g, '_');
            check(id);
            $('#idprog').val(id);
        });

        var editor;
        $('.myeditor').each(function(){
            editor = ace.edit(this.id);
            editor.setTheme("ace/theme/chrome");
            editor.getSession().setMode('ace/mode/javascript');
        });

        $('#submitProg').click(function(e){

            var val = check_ifempty(e);
            if (val == true){
                $("#confirmProg").modal();
            }
            else {

            }
        });

        $('#acceptBtn').click(function(e){
            submitProg()
        });

        $('#cancelProg').click(function(){
            $('#formaProg')[0].reset();
            $('#formadetailp')[0].reset();
            tinyMCE.activeEditor.setContent('');
            window.location.href = "http://localhost:8000/build_program";

        });

        $('#txtLang').on('change', function(){
            var lang = this.value;
            $('.myeditor').each(function(){
                editor = ace.edit(this.id);
                editor.setTheme("ace/theme/chrome");
                editor.getSession().setMode('ace/mode/'+ lang);
            });
        });

        $('#probarProg').click(function(){
            var editor = ace.edit("editor1");
            var codigo = editor.getValue();
            //var change = editor.session.getUndoManager().isClean();
            console.log(codigo)
        });

        $('#borrarProg').click(function(){
            var editor = ace.edit("editor1");
            editor.setValue(codigo);
        });



    });

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
}


    function get_activity(id,type){
        $.ajax({
            type: 'get',
            url: '/get_id',
            data: { _id: id,
                    user: '{{ user.email }}',
                    type: type},
            success: function (data){
                var obj = jQuery.parseJSON(data);
                if (jQuery.isEmptyObject(obj)){
                    alert("No puedes modificar esta actividad");
                    window.location.href = "http://localhost:8000/activitybuilder";
                }
                else{
                    load_progdata(obj)
                }

            },
            error: function(data){
                console.log(data)
            }
    });
}

    function load_progdata(obj){
        var editor = ace.edit("editor1");
        var editor2 = ace.edit("editor2");
        var editor3 = ace.edit("editor3");
        $.each(obj[0], function(key, value){
            $('#formaProg [name='+key+']').val(value);
            if (key == 'unit_test'){
                editor.setValue(value)
            }
            else if (key == "correct_code"){
                editor3.setValue(value)
            }
            else if (key == "initial_code"){
                editor2.setValue(value)
            }
            else if (key == 'tags'){
                $('#tagsprog').val("");
                for (var i=0; i < value.length ; i++){
                    $("#tagsprog").tagit("createTag", value[i]);
                }
            }
            else if (key == 'content'){
                tinyMCE.get('html').setContent(value)
            }
            else if (key == 'instructions'){
                $('#txtInstrucciones').val(value)
            }
            $('#formadetailp [name='+key+']').val(value);

    });
    }

    function check_ifempty(e){
        var isValid = true;
        if ($.trim($('#displayprog').val()) == ''){
            isValid = false;
            $('#displayprog').css({
                "border": "1px solid red",
                "background": "#FFCECE"
                    });
            }
        else {
            $('#displayprog').css({
                "border": "",
                "background": ""
                    });
        }

            if (isValid == false){
                e.preventDefault();
                return false;
                }
            else {
                return true
        }
    }

    function submitProg(){
        tinyMCE.triggerSave();
        var main= $('#formaProg').serializeArray();
        var detail = $('#formadetailp').serializeArray();
        var data = main.concat(detail);
        var obj = progData();
        var html = {
            name: "content",
            value: tinyMCE.get('html').getContent()
        };
        data.push(html);
        data.push(obj.obj1,obj.obj2,obj.obj3);
        data=indexdata(data);
        $.ajax({
            type: 'post',
            url: '/upload_activity',
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (info) {
                if (info == 'Duplicate'){
                     $.ajax({
                        type: 'post',
                        url: '/update_activity',
                        contentType: "application/json",
                        data: JSON.stringify(data),

                        success: function(info){
                            var info = jQuery.parseJSON(info);
                            if (info.updatedExisting == false){
                                alert("No puedes modificar la actividad");
                                window.location.href = "http://localhost:8000/activitybuilder";
                            }
                            else{
                                alert("Actividad modificada");
                                $('#formaProg')[0].reset();
                                $('#formadetailp')[0].reset();
                                window.location.href = "http://localhost:8000/activitybuilder";
                            }

                        },
                        error: function(info){
                            alert("Error")
                        }
                    });
                }
                else{
                    alert("Actividad agregada");
                    $('#formaProg')[0].reset();
                    $('#formadetailp')[0].reset();
                    window.location.href = "http://localhost:8000/build_program";
                }
            },
            error: function(info) {

                alert("Error. La actividad no se agrego")

            }
        });

    }

    function progData(){
        var editor = ace.edit("editor1");
        var editor2 = ace.edit("editor2");
        var editor3 = ace.edit("editor3");
        var obj1={
            'name': 'correct_code',
            'value': editor2.getValue()
        };
        var obj2={
              'name': 'initial_code',
            'value': editor3.getValue()
        };
        var obj3={
            'name': 'unit_test',
            'value': editor.getValue()
        };

        return {obj1:obj1,obj2:obj2,obj3:obj3}

    }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/ace.js " type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/theme-github.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/snippets/javascript.js" type="text/javascript" charset="utf-8"></script>


{% endblock %}