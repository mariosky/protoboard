{% extends 'activitytree/../base.html' %}

{% block style %}

    #editor1 {

        height: 500px;
        width: ;

    }

 p.test_error, p.test_failure {
    color:#d9534f;
    }

 p.test_success{
    color:#5cb85c;
    }

  .alert{
    margin:10px;
    margin-bottom:0px;
    }

{% endblock %}

{% block content %}

<div class="container-fluid" align="center">
    <div class="container-fluid">

        <ul class="nav nav-tabs">
              <li class="nav-item"> <a class="nav-link active" href="#preview-tab"  data-toggle="tab">Quiz</a></li>
              <li class="nav-item"> <a class="nav-link" href="#info-tab"  data-toggle="tab">Detail</a></li>
        </ul>


        <br>

          <div class="tab-content" style="width: 100%">
              <div class="tab-pane fade in active" id="preview-tab">
                  <form id="formaQuiz" style="width: 100%;height: 100%;align-content: center" onsubmit="return false" >
                      <div class="form-group" style="width: 100%; height: 100%">
            <!-- <tiny class="form-control" name="content" id="quiz"> </tiny> -->
                          <div class="" style="width: 28%;float: left">
                              <div class="panel panel-info" style="height:400px;max-height:450px;overflow: auto">
                                  <div class="panel-heading">
                                      <h4> Instrucciones </h4>
                                  </div>
                                  <div class="panel-body" align="left" style="font-size: small;overflow:hidden">
                                      <p>1.- Preguntas de opcion multiple, empezar respuestas con [ ]
                                          Marcar respuestas correctas [x]</p>
                                      <p>2.- Preguntas de opcion unica, empezar respuestas con ()
                                          Marcar respuesta correcta (x)</p>
                                      <p>3.- Preguntas directas, encerrar respuestas en signos = =</p>
                                      <p>4.- Se puede incluir una pista en cada pregunta.
                                          La pista se encierra entre doble {  }</p>
                                  </div>
                              </div>
                          </div>
                          <div class="myeditor" id="editor1" align="left" style="width: 70%;border:3px solid lightgrey">
Pregunta de opcion multiple encerrada entre > < con Enter entre respuestas
Marcar respuesta correcta con (x)
Ejemplo
>> Equipos que han sido campeones del mundo <<
[x] Brasil
[]Mexico
[x]Argentina
{ { Hints entre llaves } }
Pregunta de solo una respuesta ()
>> Presidente actual de Mexico <<
(x) Enrique pena Nieto
() George Bush
() Fidel Castro
Pregunta de texto directa
>>Pais de Norte America<<
=USA=
=usa=
=Estados Unidos de Norteamerica=
                          </div>
                      </div>
                  </form>
              </div>

              <div class="tab-pane fade" id="info-tab">
                  <div class="container-fluid" style="width:50%">
                      <form id="formadetailq" class="form-group" onsubmit="return false">
                          <label for="idquiz">ID</label>
                          <input type="text" readonly="readonly" class="form-control" id="idquiz" name="_id">
                          <label for="rightsquiz">Rights</label>
                          <input type="hidden" name="type" value="quiz">
                          <input type="hidden" name="author" value="{{ user.email }}">
                          <input type="text" class="form-control" id="rightsquiz" name="rights">
                          <label for="externalquiz">External URL</label>
                          <input type="text" class="form-control" id="externalquiz" name="external_url">
                          <label for="publisherquiz">Publisher</label>
                          <input type="text" class="form-control" id="publisherquiz" name="publisher"><br>
                          <label for="iconquiz">Icon</label>
                          <select id="iconquiz" name="icon" >
                              <option value="coffee">Coffee</option>
                              <option value="file">File</option>
                              <option value="youtube-play">Youtube</option>
                              <option value="puzzle-piece">Puzzle</option>
                          </select>
                          <label for="levelquiz">Level</label>
                          <select id="levelquiz" name="level">
                              <option value="principiante">Principiante</option>
                              <option value="intermedio">Intermedio</option>
                              <option value="avanzado">Avanzado</option>
                          </select><br>
                  </div>
                  </form>
              </div>
          </div>
        <br>
        <div class="container-fluid" id="formadetaildiv" style="margin-left: 3%">
            <form id="formadetailtab" onsubmit="return false">
            <div style="float:left;width: 45%;">
                <label for="displayquiz">Display Name</label>
                <input type="text" id="displayquiz" name="title" class="form-control">
                <label for="tagsquiz">Tags</label>
                <input class="form-control" id="tagsquiz" name="tags">
            </div>
            <div style="margin-left: 50%; width: 50%">
                <label for="satisfy">Satisfy at least</label>
                <input type="text" class="form-control" id="satisfy" name="satisfied_at_least">
                <label for="descriptionquiz">Description</label>
                <textarea class="form-control" id="descriptionquiz" name="description" rows="3" ></textarea>
                </form>
            </div><br>
            <br>
        </div>
        <div class="form-group" align="center">

            <a id="preview" class="btn btn-primary active" role="button" aria-pressed="true">Preview & Send </a>
            <a href="/activitybuilder" class="btn btn-secondary active" role="button" aria-pressed="true">Cancel</a>

        </div>
    </div>
</div>

 <div class="modal fade" id="modalquiz">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Add Quiz</h4>
      </div>
      <div class="modal-body">

          <div class="tab-content" style="width: 100%">
              <div class="tab-pane fade in active" id="quiz1">
                  <div class="form-group" align="center">
                      <div id="preguntas"  style="align-items: center">

                      </div>
                  </div>
              </div>
          </div>

        <div class="modal-footer">
            <div class="form-group" align="center">
            <button type="button" class="btn btn-primary" id="submitquiz">Submit</button>
            <button type="button" data-dismiss="modal" id="CancelQuiz" class="btn btn-default">Cancel</button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>tinymce.init({ selector:'tiny', height:"400", width: "500", entities: "", entity_encoding: "raw" });</script>


<script>
//checks if url has parameters to load activity
$(document).ready(function(){
    var url = getParameterByName('id');
    if (url != null){
        var type = 'quiz';
        $("#tagsquiz").tagit("removeAll");
        get_activity(url,type);
    }
    else {
        console.log(url)
    }

});

$(function(){
//loads ace editor for input of quiz by user
    var editor = ace.edit('editor1');
    editor.setTheme("ace/theme/dawn");
    editor.getSession().setMode('ace/mode/text');
    editor.renderer.setShowGutter(false);
    editor.setShowPrintMargin(false);

    //when Preview button is clicked, text is sent to be analized, then determine what type of object is going to be displayed
    $('#preview').click(function(){
        //valor = tinyMCE.activeEditor.getContent();
        valor = editor.getValue();
        var quiz = analize(valor);

        var cont = 0;
        $.each(quiz,function(index,value){
            if (value.type == "multi"){
                value.question = value.question.replace(/[>\<]/g,'');
                preview_quiz(value,cont,0);
                cont++
            }
            else if (value.type == "radio"){
                value.question = value.question.replace(/[>\<]/g,'');
                preview_quiz(value,cont,1);
                cont++
            }
            else if (value.type == "str"){
                value.question = value.question.replace(/[>\<]/g,'');
                preview_quiz(value,cont,1);
                cont++
            }
            $('#modalquiz').modal();
        });

    });

    $("#CancelQuiz").click(function(){
        window.location.href = "/build_quiz";
    });

//when submit is clicked, validates if key values were input by user
    $('#submitquiz').click(function(e){

        //get_value();
        var verificar = verify_checkbox(e);
        if (verificar == false){
            alert("Seleccione respuestas correctas")
        }
        else{
            if ($.trim($('#displayquiz').val()) == ''){
                $('#displayquiz').css({
                "border": "1px solid red",
                "background": "#FFCECE"
                    });
                alert("Ingresar nombre de Actividad")
            }
            else {
                $('#displayquiz').css({
                "border": "",
                "background": ""
                    });
                submit_quiz();
            }
            //alert("ok")
        }

    });

    //resets values in modal when modal is closed
    $(".modal").on("hidden.bs.modal", function(){
            $('#preguntas').empty()
        });

    //generates id when user inputs title
    $("#displayquiz").on('change', function(){
        var id = '/test/' + this.value.replace(/ /g, '_');
        check(id);
        $('#idquiz').val(id);
    });


});


function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

//loads activity when user is updating an existing quiz activity in db
function get_activity(id,type){
    $.ajax({
        type: 'get',
        url: '/get_id',
        data: { _id: id,
            user: '{{ user.email }}',
            type: type},
        success: function (data){
            var obj = jQuery.parseJSON( data );
            if (jQuery.isEmptyObject(obj)){
                alert("No puedes modificar esta actividad");
                window.location.href = "http://localhost:8000/activitybuilder";
            }
            else{
                load_quizdata(obj)
            }
        },
        error: function(data){
            console.log(data)
        }
    });
}

//loads the data of activity in forms for user to update
function load_quizdata(obj){
    $.each(obj[0], function(key, value){
        $('#formadetailtab [name='+key+']').val(value);
        $('#formadetailq [name='+key+']').val(value);
        if (key == 'content'){
            var editor = ace.edit('editor1');
            editor.setValue(value,1)
        }
        else if (key == 'tags'){
            $('#tagsquiz').val("");
            for (var i=0; i < value.length ; i++){
                $("#tagsquiz").tagit("createTag", value[i]);
            }
        }
        else if (key == 'description'){
            $("#descriptionquiz").val(value);
        }

    });
    }

//function that analizes input from user and store info of questions and answer in a object for each one, using regular expressions
function analize(valor){

    exp_radio = /^\s*\(.?\)/;
    exp_answer = /\[.?]/;
    exp_question = /\s*>>(.*?)<</;
    exp_correct = /^\s*\[x\]/;
    exp_radio_correct = /^\s*\(x\)/;
    exp_hint = /{*{(.*?)}}/;
    exp_text = /\=.*?=/;

    dic = [];

    //texto = valor.replace(/<\/?[^>]+(>|$)/g, "/\n/g");
    //texto = texto.replace(/&gt;/g, '>');
    //texto = texto.replace(/&lt;/g, '<');
    //texto = texto.replace(/\/g/g, '');
    //texto = texto.replace(/\//g, '');
    //texto = texto.split(/\n/g);
    //texto = texto.filter(Boolean);
    texto = valor.split(/\n/g);
    texto = texto.filter(Boolean);

    lista = [];
    correct = [];
    answers = [];
    n = 0;
    for (var i=0;i<texto.length;i++) {
        if (exp_question.test(texto[i])) {
            var match = texto[i].match(exp_question);
            obj= {
                question: match[0],
                options: '',
                answer: '',
                type:'',
                interaction:'',
                hints:'',
                id:'',
                answer_text:''
            };
            dic.push(obj);
            lista=[];
            answers=[];
            correct=[];
            hintlist=[];
            n=0;
        }
        else if (exp_answer.test(texto[i])) {
            if (texto[i].match(exp_correct)){
                var match = texto[i].split(exp_answer)[1];
                lista.push(match);
                correct.push(match);
                answers[n] = 1;
                obj['options'] = lista;
                obj['type'] = "multi";
                obj['interaction']="choiceInteraction";
                obj['id']= i;
                obj['answer_text'] = correct;
                obj['answer'] = answers;
                n = n+1;
            }
            else {
                n=n+1;
                var match = texto[i].split(exp_answer)[1];
                lista.push(match);
                obj['options'] = lista;
                obj['type'] = "multi";
                obj['interaction']="choiceInteraction";
                obj['id']= i;
                answers.push(0);
                obj['answer'] = answers
            }

        }
        else if (exp_radio.test(texto[i])){
            if (texto[i].match(exp_radio_correct)){
                var match = texto[i].split(exp_radio)[1];
                lista.push(match);
                correct[0]=match;
                obj['answer_text'] = correct;
                obj['options'] = lista;
                obj['type'] = "radio";
                obj['interaction'] = "simpleChoice";
                obj['id']= i;
                answers[n] = 1;
                n = n + 1;
                obj['answer'] = answers
            }
            else{
                n=n+1;
                var match = texto[i].split(exp_radio)[1];
                lista.push(match);
                obj['options'] = lista;
                obj['type'] = "radio";
                obj['interaction'] = "simpleChoice";
                obj['id']= i;
                answers.push(0);
                obj['answer'] = answers
            }
        }
        else if (exp_text.test(texto[i])){
            var match = texto[i].split("=")[1];
            correct.push(match);
            //answers.push(match);
            obj['answer'] = correct;
            obj['answer_text'] = correct;
            //obj['options'] = correct;
            obj['type'] = "str";
            obj['interaction'] = "textEntryInteraction";
            obj['id'] = i;
        }
        else if (exp_hint.test(texto[i])){
            var match = texto[i].split(exp_hint)[1];
            hintlist.push(match);
            obj['hints'] = hintlist;
        }


    }

    $('#preguntas').empty();
    return dic;


}

//an object and a flag is received, depending on flag, elements are appended to a div to be displayed to the user
function preview_quiz(obj,cont,flag){

    var container = $('#preguntas');
    if (flag == 1){
        $('<br>').appendTo(container);
        $('<label /> ', {text: obj.question}).appendTo(container);
        $('<br>').appendTo(container);
        for (var i = 0; i < obj.answer_text.length ; i++) {
            $('<i class="fa fa-check-circle"></i>').appendTo(container);
            $('<label />', {'for': 'cb' + i, text: obj.answer_text[i]}).appendTo(container);
            $('<br>').appendTo(container);
        }


    }
    else if (flag == 0){
        $('<br>').appendTo(container);
        $('<label /> ', {text: obj.question}).appendTo(container);
        $('<br>').appendTo(container);

        for (var i = 0; i < obj.answer_text.length ; i++) {
            $('<i class="fa fa-check-square-o"></i>').appendTo(container);
            $('<label />', {'for': 'cb' + i, text: obj.answer_text[i]}).appendTo(container);
            $('<br>').appendTo(container);

        }

    }
}

function verify_checkbox(){
    var flag = true;
    for (var i=0;i < dic.length;i++){
        if (dic[i].answer_text.length == 0){
            flag = false
        }
    }
    return flag

}

//function that gets all data from forms and send it to server for insertion, updates activity if it already exists
function submit_quiz(){
    if ($("#satisfy").val() == ""){
        $("#satisfy").val(dic.length);
    }
    var detail = $('#formadetailq').serializeArray();
    var detailtab = $("#formadetailtab").serializeArray();
    detail = detail.concat(detailtab);
    var questions = {
        name: 'questions',
        value: dic
    };
    detail.push(questions);
    var content = {
            name: 'content',
            value: valor
        };
    detail.push(content);
    var data = indexdata(detail);
    console.log(data);
    $.ajax({
        type: 'post',
        url: '/upload_activity',
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function (info) {
            info = jQuery.parseJSON(info);
            if (info.updatedExisting == true){
                alert("Actividad modificada");
                $('#formadetailq')[0].reset();
                $("#modalquiz").modal('hide');
                window.location.href = "/activitybuilder";
            }
            else if (info.updatedExisting == false){
                alert("Actividad agregada");
                $('#formadetailq')[0].reset();
                $("#modalquiz").modal('hide');
                window.location.href = "/activitybuilder";
            }
            else if (info.message == "Duplicated"){
                alert("Duplicated Entry");
                $('#formadetailq')[0].reset();
                $("#modalquiz").modal('hide');
                window.location.href = "/quiz_builder";
                }
        },
        error: function(info) {

            alert("Error. La actividad no se agrego")

        }
    });
}

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/ace.js " type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/theme-github.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/snippets/javascript.js" type="text/javascript" charset="utf-8"></script>

{% endblock %}