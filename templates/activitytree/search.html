{% extends "activitytree/base.html" %}

{% block content %}
<h3>Biblioteca </h3>
    <nav class="navbar navbar-default">

      <div class="container-fluid">
                <row>
                          <form class="form" role="search" onsubmit="return false">
                             <div class="input-group">
                                 <input class="form-control" type="text" placeholder="Search by Title or #Tag" name="srch-term" id="txtname">
                                <span class="input-group-btn">
                            <button class="btn  btn-secondary" type="submit">Search</button>
                                     </span>
                             </div>

                          </form>

               </row>
      </div>
    </nav>

    <div class="col-md-12">
           <div class="card-deck-wrapper">
               <div id='actividades' class="card-columns">

              </div>
           </div>
    </div>


    <nav aria-label="Page navigation" id="paginator" align="center">


    </nav>

{% endblock %}

{% block scripts %}




<script id="activities_template" type="x-tmpl-mustache">

<div class="card">
<div class="card-block">

  <h6 class="card-title"> <i class="fa fa-[[icon]]"> </i> <a href="[[id]]">[[title]]</a> </h6>



  <p class="card-text"> [[description]]</p>

   [[#has_tags]]
    <i class="fa fa-tags"></i>
        [[/has_tags]]

              [[#tags]]
              [[#.]]
              <span class="label label-info"><a href="/search/?tag=[[.]]" style="color:#FFFFFF">[[.]]</a></span>
              [[/.]]
              [[^.]]
              [[/.]]
        [[/tags]]
</div>


        <div class="card-footer">
                <button type="button" value="[[id]]" onclick='copyToClipboard("[[id]]")' data-toggle="" data-target="#"  data-href="[[id]]" class="btn btn-secondary   editBtn"><i class="fa fa-clipboard clipBtn"></i> </button>

        </div>
</div>




</script>

<script id="paginator_template" type="x-tmpl-mustache">
    <ul class="pagination">

    [[#prev]]
     <li class="page-item" data-page='[[prevPage]]'>
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>

    [[/prev]]

       [[#pages]]
          [[#page]]
                <li class="page-item [[#active]]active[[/active]]" data-page=[[page]]><a class="page-link"  href="#">[[page]]</a></li>

          [[/page]]

          [[^.]]
          [[/.]]
       [[/pages]]

    [[#next]]
    <li class="page-item" data-page=[[nextPage]]>
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>


    [[/next]]
 </ul>
</script>

<script type="text/javascript">




    $(function(){
        //if parameter is submitted on url, gets the value and send it to loadifurl function, if not, loads all activities in db
        var urltype = geturltype();

        var tags = [];
        var query = { page:0, type: {'type': {'$in':['text','video','quiz','prog']} } };

        if (typeof urltype != 'undefined') {

                loadIfUrl(urltype[1], 'tags',query);
        }
        else{
            query_builder(query);
        }


        });

function buscar(query){
        $.ajax({
        type: 'POST',
        url: '/search_prueba',
        data: JSON.stringify(query),
        success: function (data) {
            var obj = jQuery.parseJSON( data );
            if (obj == "null" || obj[0].count == 0){
                $("#paginator").empty();
                $("#actividades").append('<h3 style="color:lightgray">No hay actividades</h3>');
                count = 0
            }
            else{
                Mustache.tags = ['[[', ']]'];
                var activities_template = $('#activities_template').html();
                Mustache.parse(activities_template);
                $.each(obj, function( index, value ) {
                    if (value.count){
                        count = value.count
                    }
                    else{
                        rendered = Mustache.render(activities_template, {
                            title: value.title,
                            id: value._id,
                            icon:value.icon,
                            description: value.description,
                            lang:value.lang,
                            level:value.level,
                            type:value.type,
                            tags:value.tags});
                        $("#actividades").append(rendered);
                    }
                });

                renderPaginator( query['page']+1, Math.floor((count + 10 -1)/10), 10, on_click );
                $('#actividades').val(data);

            }
        },
        error: function(data) {
            console.log("Error");
        }
    });
    }


$("#txtname").on('change', function(){
   $("#actividades").empty();
   $("#row").show();
    query_builder({ page:0, type: {'type': {'$in':['text','video','quiz','prog']}}});
 });




var on_click = function(){
        var pagenum = $( this ).attr('data-page');
        $("#actividades").empty();

        buscar({ page:pagenum - 1, type: {'type': {'$in':['text','video','quiz','prog']}}});
    }




        //gets parameter from url and returns values
        function geturltype(){
            var parameters = window.location.href.split("?");
            if (parameters.length > 1){
                parameters.splice(0,1);
                for (var i=0;i<parameters.length;i++){
                    var vars = parameters[i].split("=");
                    return vars;
                }
            }
            else{
                return undefined;
            }
        }


        //function that categorizes data received (from url) and sends it to query_builder with correct parameters
        function loadIfUrl(type, category, query) {


            if (category == "tags") {
                $("#actividades").empty();
                $("#txtname").val("#" + type);
                query_builder(query);
            }

        }


    //when copytoclipboard button is clicked, a message is displayed to user
    function copyToClipboard(text) {
        window.prompt("Copy to clipboard: Ctrl+C, Enter", text);
        }



    </script>



{% endblock %}